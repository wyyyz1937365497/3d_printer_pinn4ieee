%% 数据流程可视化
% 用途：生成系统架构和数据流程图
% 输出：flow_diagram.png

clear; clc; close all;

fprintf('生成数据流程图...\n');

figure('Name', '3D打印仿真系统 - 数据流程', 'Position', [100, 100, 1400, 900]);

%% 子图1：系统架构
subplot(2, 2, 1);
axis off;

text_str = {
    '═══════════════════════════════════════════════════════════════'
    '                  3D打印仿真系统架构                          '
    '═══════════════════════════════════════════════════════════════'
    '                                                                '
    '  ┌─────────────────────────────────────────────────────────┐  '
    '  │              输入层 (参数设置)                           │  '
    '  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │  '
    '  │  │运动参数  │  │热学参数  │  │G-code    │              │  '
    '  │  │速度      │  │温度      │  │轨迹类型  │              │  '
    '  │  │加速度    │  │环境      │  │转角      │              │  '
    '  │  └────┬─────┘  └────┬─────┘  └────┬─────┘              │  '
    '  └───────┼────────────┼─────────────┼──────────────────────┘  '
    '          │            │             │                         '
    '          ▼            ▼             ▼                         '
    '  ┌─────────────────────────────────────────────────────────┐  '
    '  │              仿真层 (物理建模)                           │  '
    '  │  ┌──────────────────┐     ┌──────────────────┐         │  '
    '  │  │  模块1: 轨迹误差  │     │  模块2: 温度场    │         │  '
    '  │  │  ┌────────────┐  │     │  ┌────────────┐  │         │  '
    '  │  │  │二阶系统    │  │     │  │热传导方程  │  │         │  '
    '  │  │  │m·x''+c·x''+k·x│  │     │  │∂T/∂t=α·∇²T│  │         │  '
    '  │  │  │= F(t)      │  │     │  │+Q_source   │  │         │  '
    '  │  │  └─────┬──────┘  │     │  └─────┬──────┘  │         │  '
    '  │  │        │         │     │        │         │         │  '
    '  │  │  轨迹误差数据    │     │  温度场数据       │         │  '
    '  │  └────────┬─────────┘     └────────┬─────────┘         │  '
    '  └───────────┼─────────────────────────┼──────────────────┘  '
    '              │                         │                     '
    '              ▼                         ▼                     '
    '  ┌─────────────────────────────────────────────────────────┐  '
    '  │          模块3: 粘结力计算                               │  '
    '  │  ┌────────────────────────────────────────────────┐    │  '
    '  │  │  基于温度历史的分子扩散模型                      │    │  '
    '  │  │  σ_adhesion = f(T, t, dT/dt)                    │    │  '
    '  │  └────────────────────┬───────────────────────────┘    │  '
    '  └───────────────────────┼───────────────────────────────┘  '
    '                          │                                 '
    '                          ▼                                 '
    '  ┌─────────────────────────────────────────────────────────┐  '
    '  │              输出层 (数据整合)                          │  '
    '  │  ┌────────────────────────────────────────────────┐    │  '
    '  │  │  50个输入特征 + 4个输出目标                     │    │  '
    '  │  │  • 轨迹误差模块 (20个)                          │    │  '
    '  │  │  • 温度场模块 (18个)                            │    │  '
    '  │  │  • G-code特征 (8个)                             │    │  '
    '  │  │  • 其他参数 (4个)                               │    │  '
    '  │  └────────────────────┬───────────────────────────┘    │  '
    '  └───────────────────────┼───────────────────────────────┘  '
    '                          │                                 '
    '                          ▼                                 '
    '  ┌─────────────────────────────────────────────────────────┐  '
    '  │          Python训练数据 (.mat, .csv)                    │  '
    '  └─────────────────────────────────────────────────────────┘  '
    '                                                                '
    '═══════════════════════════════════════════════════════════════'
};

text(0.05, 0.95, text_str, 'Units', 'normalized', 'VerticalAlignment', 'top', ...
    'FontName', 'Courier New', 'FontSize', 8, 'Family', 'monospace');

title('系统架构', 'FontSize', 14, 'FontWeight', 'bold');

%% 子图2：轨迹误差因果链
subplot(2, 2, 2);
axis off;

text_str = {
    '════════════════════════════════════════════════════════'
    '            轨迹误差因果链 (因果链A)                      '
    '════════════════════════════════════════════════════════'
    '                                                         '
    '  G-code轨迹 (转角、速度变化)                            '
    '           │                                             '
    '           ▼                                             '
    '  ┌───────────────────────┐                             '
    '  │  参考加速度 a_ref(t)  │                             '
   '   │  = dv/dt             │                             '
    '  └───────────┬───────────┘                             '
    '              │                                         '
    '              ▼                                         '
    '  ┌───────────────────────┐                             '
    '  │  惯性力 F_inertia    │                             '
    '  │  = m × a_ref         │                             '
    '  └───────────┬───────────┘                             '
    '              │                                         '
    '              ▼                                         '
    '  ┌───────────────────────────────────────┐             '
    '  │    二阶系统响应 (质量-弹簧-阻尼)       │             '
    '  │                                       │             '
    '  │    m·x'' + c·x'' + k·x = F(t)          │             '
    '  │                                       │             '
    '  │    ┌─────────┐  ┌─────────┐           │             '
    '  │    │ 惯性    │  │ 弹性    │           │             '
    '  │    │ m       │  │ k       │           │             '
    '  │    └────┬────┘  └────┬────┘           │             '
    '  │         │            │                │             '
    '  │         └─────┬──────┘                │             '
    '  │               ▼                       │             '
    '  │         ┌─────────┐                   │             '
    '  │         │ 阻尼 c  │                   │             '
    '  │         └─────────┘                   │             '
    '  └─────────────────┬─────────────────────┘             '
    '                    │                                   '
    '                    ▼                                   '
    '  ┌───────────────────────────────┐                    '
    '  │  实际位置 x_act(t)            │                    '
    '  │  = H(s) × x_ref(s)            │                    '
    '  │                               │                    '
    '  │  特性:                         │                    '
    '  │  • 超调量 M_p                  │                    '
    '  │  • 震荡频率 ω_d                │                    '
    '  │  • 上升时间 t_r                │                    '
    '  └───────────────┬───────────────┘                    '
    '                  │                                     '
    '                  ▼                                     '
    '  ┌───────────────────────────────┐                    '
    '  │  位置误差 ε = x_act - x_ref   │                    '
    '  │                               │                    '
    '  │  关键时刻: 转角处！            │                    '
    '  │  • 速度突变 → 加速度大        │                    '
    '  │  • 惯性力大 → 皮带伸长大      │                    '
    '  │  • 震荡响应 → 误差震荡        │                    '
    '  └───────────────────────────────┘                    '
    '                                                         '
    '  【输出】最大位置误差 ε_r                                '
    '                                                         '
    '════════════════════════════════════════════════════════'
};

text(0.05, 0.95, text_str, 'Units', 'normalized', 'VerticalAlignment', 'top', ...
    'FontName', 'Courier New', 'FontSize', 9, 'Family', 'monospace');

title('轨迹误差因果链', 'FontSize', 14, 'FontWeight', 'bold');

%% 子图3：粘结力因果链
subplot(2, 2, 3);
axis off;

text_str = {
    '════════════════════════════════════════════════════════'
    '           粘结力因果链 (因果链B)                        '
    '════════════════════════════════════════════════════════'
    '                                                         '
    '  G-code轨迹 → 喷嘴位置 (x,y,z)(t)                      '
    '                  │                                     '
    '                  ▼                                     '
    '  ┌─────────────────────────────────────────┐          '
    '  │  挤出速度 + 流量 → 热输入 Q_in(t)        │          '
    '  │  Q = ρ × c × v_extrude × (T_noz - T_bed)│          '
    '  └──────────────────┬──────────────────────┘          '
    '                     │                                  '
    '                     ▼                                  '
    '  ┌─────────────────────────────────────────┐          '
    '  │      移动热源边界条件                    │          '
    '  │                                         │          '
    '  │      ┌─────────┐                        │          '
    '  │      │ 喷嘴    │  ← 移动热源             │          '
    '  │      │ T=220°C │                        │          '
    '  │      └────┬────┘                        │          '
    '  │           │                             │          '
    '  │           ▼                             │          '
    '  │      ┌─────────┐                        │          '
    '  │      │ 打印件  │                        │          '
    '  │      │ T(x,y,z)│                        │          '
    '  │      └─────────┘                        │          '
    '  └──────────────────┬──────────────────────┘          '
    '                     │                                  '
    '                     ▼                                  '
    '  ┌─────────────────────────────────────────┐          '
    '  │      热传导方程求解                      │          '
    '  │                                         │          '
    '  │  ∂T/∂t = α·∇²T + Q_source - Q_cooling   │          '
    '  │                                         │          '
    '  │  冷却机制:                               │          '
    '  │  • 对流: h×(T-T_ambient)  ⭐ T_ambient!  │          '
    '  │  • 辐射: ε×σ×(T⁴-T_amb⁴)                 │          '
    '  │                                         │          '
    '  └──────────────────┬──────────────────────┘          '
    '                     │                                  '
    '                     ▼                                  '
    '  ┌─────────────────────────────────────────┐          '
    '  │     温度场 T(x,y,z,t)                    │          '
    '  │                                         │          '
    '  │  关键量:                                 │          '
    '  │  • 层间温度 T_interface                  │          '
    '  │  • 冷却速率 dT/dt                        │          '
    '  │  • 时间高于熔点 t_above_Tm               │          '
    '  │  • 温度梯度 ∇T                           │          '
    '  └──────────────────┬──────────────────────┘          '
    '                     │                                  '
    '                     ▼                                  '
    '  ┌─────────────────────────────────────────┐          '
    '  │     分子扩散模型                         │          '
    '  │                                         │          '
    '  │  1. 扩散系数 D(T):                       │          '
    '  │     D = D₀ × exp(-Ea/RT)                │          '
    '  │                                         │          '
    '  │  2. 扩散深度 d:                          │          '
    '  │     d = √(D × t_above_Tm)               │          '
    '  │                                         │          '
    '  │  3. 粘结强度 σ:                          │          '
    '  │     σ ∝ (1 - exp(-d/d₀)) × f(T)         │          '
    '  │                                         │          '
    '  └──────────────────┬──────────────────────┘          '
    '                     │                                  '
    '                     ▼                                  '
    '  ┌─────────────────────────────────────────┐          '
    '  │  层间粘结强度 σ_adhesion(x,y)           │          '
    '  │                                         │          '
    '  │  影响因素:                               │          '
    '  │  ✓ 层间温度高 → 强度高                   │          '
    '  │  ✓ 冷却速率慢 → 强度高                   │          '
    '  │  ✓ 时间高于熔点长 → 强度高               │          '
    '  │  ✗ 环境温度低 → 冷却快 → 强度低          │          '
    '  │                                         │          '
    '  └─────────────────────────────────────────┘          '
    '                                                         '
    '  【输出】层间粘结强度 σ_adhesion                        '
    '                                                         '
    '════════════════════════════════════════════════════════'
};

text(0.05, 0.95, text_str, 'Units', 'normalized', 'VerticalAlignment', 'top', ...
    'FontName', 'Courier New', 'FontSize', 9, 'Family', 'monospace');

title('粘结力因果链', 'FontSize', 14, 'FontWeight', 'bold');

%% 子图4：数据流程
subplot(2, 2, 4);
axis off;

text_str = {
    '════════════════════════════════════════════════════════'
    '                数据转换流程                            '
    '════════════════════════════════════════════════════════'
    '                                                         '
    '  MATLAB仿真                                            '
    '  ┌─────────────────────────────────────────┐          '
    '  │  run_full_simulation.m                  │          '
    '  │                                         │          '
    '  │  for i = 1:num_samples                  │          '
    '  │    1. generate_gcode()                  │          '
    '  │    2. simulate_trajectory_error()       │          '
    '  │    3. simulate_thermal_field()          │          '
    '  │    4. calculate_adhesion()              │          '
    '  │  end                                    │          '
    '  │                                         │          '
    '  │  输出: all_data (cell array)            │          '
    '  └──────────────────┬──────────────────────┘          '
    '                     │                                  '
    '                     ▼                                  '
    '  ┌─────────────────────────────────────────┐          '
    '  │  export_to_python.m                     │          '
    '  │                                         │          '
    '  │  提取特征:                               │          '
    '  │  • 50个输入特征 → X矩阵                 │          '
    '  │  • 4个输出目标 → y矩阵                  │          '
    '  │                                         │          '
    '  │  转换格式:                               │          '
    '  │  1. .mat (v7.3) ← scipy.io.loadmat()    │          '
    '  │  2. .csv        ← pandas.read_csv()     │          '
    '  │  3. _loader.py ← 自动生成加载脚本       │          '
    '  └──────────────────┬──────────────────────┘          '
    '                     │                                  '
    '                     ▼                                  '
    '  ┌─────────────────────────────────────────┐          '
    '  │  Python训练                              │          '
    '  │                                         │          '
    '  │  from scipy.io import loadmat           │          '
    '  │  data = loadmat(''..._python.mat'')     │          '
    '  │  X = data[''X'']  # (N, 50)             │          '
    '  │  y = data[''y'']  # (N, 4)              │          '
    '  │                                         │          '
    '  │  X_train, X_test, y_train, y_test =     │          '
    '  │      train_test_split(X, y)             │          '
    '  │                                         │          '
    '  │  # 训练PINN模型                          │          '
    '  │  model = create_pinn_model()            │          '
    '  │  model.fit(X_train, y_train)            │          '
    '  └─────────────────────────────────────────┘          '
    '                                                         '
    '════════════════════════════════════════════════════════'
    '                                                         '
    '  文件映射:                                              '
    '  ┌────────────────────┬─────────────────────────┐      '
    '  │ MATLAB格式          │ Python格式              │      '
    '  ├────────────────────┼─────────────────────────┤      '
    '  │ .mat (v7.3)        │ scipy.io.loadmat()      │      '
    '  │ .csv               │ pandas.read_csv()       │      '
    '  │ struct             │ dict / numpy.ndarray    │      '
    '  │ cell array         │ list of arrays         │      '
    '  │ double             │ float64                │      '
    '  └────────────────────┴─────────────────────────┘      '
    '                                                         '
    '════════════════════════════════════════════════════════'
};

text(0.05, 0.95, text_str, 'Units', 'normalized', 'VerticalAlignment', 'top', ...
    'FontName', 'Courier New', 'FontSize', 9, 'Family', 'monospace');

title('数据转换流程', 'FontSize', 14, 'FontWeight', 'bold');

%% 保存图像
output_dir = './output';
if ~exist(output_dir, 'dir')
    mkdir(output_dir);
end

output_file = fullfile(output_dir, 'flow_diagram.png');
fprintf('保存图像: %s\n', output_file);
saveas(gcf, output_file);

fprintf('流程图生成完成！\n');
