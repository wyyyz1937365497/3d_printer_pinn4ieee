# PINN-Based 3D Printing Trajectory Error Correction

åŸºäºŽç‰©ç†ä¿¡æ¯ç¥žç»ç½‘ç»œ(PINN)çš„3Dæ‰“å°è½¨è¿¹è¯¯å·®å®žæ—¶ä¿®æ­£ç³»ç»Ÿ

## ðŸŽ¯ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨æ·±åº¦å­¦ä¹ ç»“åˆç‰©ç†çº¦æŸæ¥é¢„æµ‹å’Œä¿®æ­£3Dæ‰“å°è¿‡ç¨‹ä¸­çš„è½¨è¿¹è¯¯å·®ï¼Œæé«˜æ‰“å°ç²¾åº¦ã€‚

**æ ¸å¿ƒåˆ›æ–°ç‚¹**:
- ðŸ§  **ç‰©ç†ä¿¡æ¯ç¥žç»ç½‘ç»œ(PINN)**: ç»“åˆæ•°æ®é©±åŠ¨å’Œç‰©ç†çº¦æŸ
- ðŸ“¸ **è®¡ç®—æœºè§†è§‰**: è‡ªåŠ¨åŒ–æ•°æ®æ”¶é›†å’Œè¯¯å·®æµ‹é‡
- ðŸ”„ **å®žæ—¶ä¿®æ­£**: 0.6msæŽ¨ç†å»¶è¿Ÿï¼Œæ”¯æŒåœ¨çº¿è¡¥å¿
- ðŸ“Š **æ··åˆè®­ç»ƒ**: çœŸå®žæµ‹é‡æ•°æ® + ä»¿çœŸç‰©ç†æ•°æ®

## ðŸ“¦ ç³»ç»Ÿæž¶æž„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®æ”¶é›†é˜¶æ®µ                              â”‚
â”‚                                                              â”‚
â”‚  Klipper (10.168.1.123:19255)                              â”‚
â”‚    â†“ (æ¯å±‚å®Œæˆè§¦å‘)                                          â”‚
â”‚  FlaskæœåŠ¡ (10.168.1.129:5000)                             â”‚
â”‚    â†“ (HTTP GET)                                             â”‚
â”‚  IPæ‘„åƒå¤´ (10.168.1.129:8080/shot.jpg)                     â”‚
â”‚    â†“ (å›¾åƒå¤„ç†)                                             â”‚
â”‚  è½®å»“æå– â†’ ICPå¯¹é½ â†’ è¯¯å·®è®¡ç®— â†’ ä¿å­˜NPZ                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¨¡åž‹è®­ç»ƒé˜¶æ®µ                              â”‚
â”‚                                                              â”‚
â”‚  NPZæ•°æ®é›† + ä»¿çœŸæ•°æ® â†’ HybridDataset                      â”‚
â”‚    â†“                                                        â”‚
â”‚  PINNæ¨¡åž‹è®­ç»ƒ (Î»_dataÂ·Loss_data + Î»_physicsÂ·Loss_physics)  â”‚
â”‚    â†“                                                        â”‚
â”‚  ä¿å­˜æœ€ä½³æ¨¡åž‹ (checkpoints/pinn/best_model.pth)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¿®æ­£åº”ç”¨é˜¶æ®µ                              â”‚
â”‚                                                              â”‚
â”‚  G-codeæ–‡ä»¶ â†’ LSTMæ¨¡åž‹æŽ¨ç† â†’ ä¿®æ­£åŽG-code                 â”‚
â”‚    â†“                                                        â”‚
â”‚  æ‰“å°éªŒè¯ â†’ ç²¾åº¦æµ‹é‡ â†’ è¯¯å·®åˆ†æž                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆçŽ°æœ‰é…ç½®ï¼‰

### å‰ææ¡ä»¶

- âœ… Klipperå·²è¿è¡Œåœ¨ `10.168.1.123:19255`
- âœ… IPæ‘„åƒå¤´å·²é…ç½®åœ¨ `10.168.1.129:8080`
- âœ… Python 3.8+
- âœ… è“è‰²PLAææ–™ï¼ˆæŽ¨èï¼Œæé«˜å¯¹æ¯”åº¦ï¼‰

### æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–

```bash
cd F:\TJ\3d_print\3d_printer_pinn4ieee
pip install -r requirements.txt
```

### æ­¥éª¤2ï¼šæµ‹è¯•ç¡¬ä»¶è¿žæŽ¥

```bash
python experiments/test_existing_setup.py
```

é¢„æœŸè¾“å‡ºï¼š
```
=== æ•°æ®æ”¶é›†å™¨åˆå§‹åŒ– ===
Klipper API: http://10.168.1.123:19255
æ‘„åƒå¤´å¿«ç…§: http://10.168.1.129:8080/shot.jpg
è¾“å‡ºç›®å½•: data\collected_photos

âœ… Klipperè¿žæŽ¥æˆåŠŸ
   æ‰“å°æœºåç§°: voron
   Klipperç‰ˆæœ¬: v0.11.0-249-ge6a09c72
   MCU: mcu

âœ… IPæ‘„åƒå¤´è¿žæŽ¥æˆåŠŸ
   åˆ†è¾¨çŽ‡: 1920x1080
   æµ‹è¯•ç…§ç‰‡å·²ä¿å­˜: data\collected_photos\camera_test.jpg
```

### æ­¥éª¤3ï¼šé…ç½®Klipperå®

ç¼–è¾‘ `printer.cfg`ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```ini
[gcode_macro LAYER_COMPLETE]
description: "è§¦å‘æ•°æ®æ”¶é›†æ‹ç…§"
gcode:
    {action_respond_info("Layer {printer.gcode_move.position_z} complete, capturing...")}
    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.129:5000/capture",
            body={"layer": printer.gcode_move.position.z|int,
                   "filename": printer.print_stats.filename}
        )}
    {% endif %}
```

è¯¦è§ `docs/KLIPPER_MACROS.cfg`

### æ­¥éª¤4ï¼šå¯åŠ¨æ•°æ®æ”¶é›†æœåŠ¡

```bash
python experiments/auto_data_collector_existing.py \
    --klipper-host 10.168.1.123 \
    --klipper-port 19255 \
    --camera-host 10.168.1.129 \
    --camera-port 8080 \
    --output data/collected_photos
```

æœåŠ¡å¯åŠ¨åŽä¼šæ˜¾ç¤ºï¼š
```
==================================================
è‡ªåŠ¨æ•°æ®æ”¶é›†æœåŠ¡å¯åŠ¨
==================================================
  Klipper: 10.168.1.123:19255
  æ‘„åƒå¤´: 10.168.1.129:8080
  HTTPç«¯å£: 5000
  è¾“å‡ºç›®å½•: data/collected_photos

APIç«¯ç‚¹:
  POST http://localhost:5000/capture
  GET  http://localhost:5000/status
  POST http://localhost:5000/save
  POST http://localhost:5000/stop

ç­‰å¾…Klipperè¯·æ±‚...
```

### æ­¥éª¤5ï¼šé…ç½®SliceråŽå¤„ç†

åœ¨Cura/PrusaSlicerä¸­ï¼Œæ¯å±‚ç»“æŸåŽæ’å…¥ `LAYER_COMPLETE` å‘½ä»¤ã€‚

æˆ–æ‰‹åŠ¨ç¼–è¾‘G-codeï¼š
```bash
# æŸ¥æ‰¾æ›¿æ¢
æŸ¥æ‰¾: ;LAYER:
æ›¿æ¢: ;LAYER:\nLAYER_COMPLETE
```

### æ­¥éª¤6ï¼šå¼€å§‹æ‰“å°å¹¶æ”¶é›†æ•°æ®

1. åœ¨Mainsailä¸­ä¸Šä¼ æµ‹è¯•G-code
2. å¼€å§‹æ‰“å°
3. æ¯å±‚å®Œæˆæ—¶ä¼šè‡ªåŠ¨æ‹ç…§
4. è§‚å¯Ÿç»ˆç«¯è¾“å‡ºï¼š
   ```
   INFO - å¤„ç†å±‚ 1
   INFO -   å›¾åƒå·²ä¿å­˜: test_layer001_20250205_143022.jpg
   INFO -   å¤„ç†æˆåŠŸ: 1234ç‚¹, RMS=45.23um
   ```

### æ­¥éª¤7ï¼šä¿å­˜æ•°æ®é›†

æ‰“å°å®ŒæˆåŽï¼š
```bash
curl -X POST http://10.168.1.129:5000/save
```

æ•°æ®ä¿å­˜ä¸ºï¼š
```
data/collected_photos/
â”œâ”€â”€ dataset_20250205_143022.npz
â”œâ”€â”€ metadata_20250205_143022.json
â”œâ”€â”€ test_layer001_*.jpg
â””â”€â”€ ...
```

## ðŸ§  æ¨¡åž‹è®­ç»ƒ

### ä½¿ç”¨æ”¶é›†çš„æ•°æ®è®­ç»ƒ

```bash
python training/train_pinn.py \
    --mode finetune \
    --real_data data/collected_photos/dataset_*.npz \
    --epochs 200 \
    --batch_size 32 \
    --lr 1e-3 \
    --output_dir checkpoints/pinn
```

### æ··åˆè®­ç»ƒï¼ˆçœŸå®žæ•°æ® + ä»¿çœŸæ•°æ®ï¼‰

```bash
python training/train_pinn.py \
    --mode hybrid \
    --real_data data/collected_photos/dataset_*.npz \
    --sim_data data_simulation_*/trajectory_*.mat \
    --epochs 300 \
    --output_dir checkpoints/pinn
```

### é¢„è®­ç»ƒï¼ˆä»…ä»¿çœŸæ•°æ®ï¼‰

```bash
python training/train_pinn.py \
    --mode pretrain \
    --sim_data data_simulation_*/trajectory_*.mat \
    --epochs 500 \
    --output_dir checkpoints/pinn
```

## ðŸ“ é¡¹ç›®ç»“æž„

```
3d_printer_pinn4ieee/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ pinn_trajectory_model.py     # PINNæ¨¡åž‹å®šä¹‰
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ vision_processor.py          # è§†è§‰å¤„ç†å™¨
â”œâ”€â”€ training/
â”‚   â””â”€â”€ train_pinn.py                # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ experiments/
â”‚   â”œâ”€â”€ auto_data_collector_existing.py  # Flaskæ•°æ®æ”¶é›†æœåŠ¡
â”‚   â””â”€â”€ test_existing_setup.py       # ç¡¬ä»¶æµ‹è¯•å·¥å…·
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ START_WITH_EXISTING_SETUP.md    # å®Œæ•´å¯åŠ¨æŒ‡å—
â”‚   â””â”€â”€ KLIPPER_MACROS.cfg           # Klipperå®æ¨¡æ¿
â”œâ”€â”€ data/
â”‚   â””â”€â”€ collected_photos/            # æ”¶é›†çš„æ•°æ®
â”œâ”€â”€ checkpoints/
â”‚   â””â”€â”€ pinn/                        # è®­ç»ƒçš„æ¨¡åž‹
â””â”€â”€ requirements.txt
```

## ðŸ”§ æ¨¡åž‹æž¶æž„

### TrajectoryPINN (MLPç‰ˆæœ¬)

```
è¾“å…¥: [x, y, vx, vy, ax, ay, curvature] (7ç»´)
  â†“
éšè—å±‚: [128, 128, 64, 64] + Tanh
  â†“
è¾“å‡º: [error_x, error_y] (2ç»´)
```

**ç‰©ç†çº¦æŸ**:
- ç¨³æ€è¯¯å·®ç†è®º: `error â‰ˆ -(m/k)Â·a_ref`
- æŸå¤±å‡½æ•°: `Loss = Î»_dataÂ·MSE(pred, label) + Î»_physicsÂ·MSE(pred, -m/kÂ·a_ref)`

**ç‰©ç†å‚æ•°**:
- è´¨é‡ m = 0.35 kg
- åˆšåº¦ k = 8000 N/m
- é˜»å°¼ c = 15 Ns/m

### SequencePINN (LSTMç‰ˆæœ¬)

é€‚ç”¨äºŽæ—¶åºè½¨è¿¹æ•°æ®ï¼Œæ”¯æŒå¤šæ­¥é¢„æµ‹ã€‚

## ðŸ“Š è®­ç»ƒç»“æžœ

é¢„æœŸæ€§èƒ½æŒ‡æ ‡ï¼š
- **RÂ² Score**: > 0.9
- **RMSè¯¯å·®**: < 50 Î¼m
- **æŽ¨ç†å»¶è¿Ÿ**: ~0.6 ms (CPU)

## ðŸ› ï¸ æ•…éšœæŽ’é™¤

### Q1: IPæ‘„åƒå¤´è¿žæŽ¥å¤±è´¥

```bash
# æ£€æŸ¥æ‘„åƒå¤´æ˜¯å¦å¯è®¿é—®
curl http://10.168.1.129:8080/shot.jpg -o test.jpg

# æ£€æŸ¥é˜²ç«å¢™
# Windows: è®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ Windowsé˜²ç«å¢™
```

### Q2: Klipperå®ä¸è§¦å‘

1. æ£€æŸ¥å®è¯­æ³•: `sudo journalctl -u klipper -f`
2. æ‰‹åŠ¨æµ‹è¯•: åœ¨MainsailæŽ§åˆ¶å°è¾“å…¥ `LAYER_COMPLETE`
3. ç¡®è®¤G-codeä¸­å·²æ’å…¥å‘½ä»¤

### Q3: è½®å»“æå–å¤±è´¥

**å¯èƒ½åŽŸå› **:
- ææ–™é¢œè‰²ä¸å¯¹ï¼ˆéœ€è¦è“è‰²/ç™½è‰²PLAï¼‰
- ç…§æ˜Žä¸è¶³
- å¯¹ç„¦ä¸å‡†

**è§£å†³æ–¹æ¡ˆ**:
1. ä½¿ç”¨è“è‰²PLAæ‰“å°
2. å¢žåŠ çŽ¯å¢ƒå…‰æˆ–LEDç…§æ˜Ž
3. è°ƒæ•´æ‘„åƒå¤´å¯¹ç„¦ï¼ˆè½¬åŠ¨é•œå¤´çŽ¯ï¼‰

### Q4: è®­ç»ƒæ—¶å†…å­˜ä¸è¶³

```bash
# å‡å°batch size
python training/train_pinn.py --batch_size 16

# ä½¿ç”¨æ›´å°çš„æ¨¡åž‹
python training/train_pinn.py --hidden_sizes 64 64 32 32
```

## ðŸ“š è¯¦ç»†æ–‡æ¡£

- **å®Œæ•´å¯åŠ¨æŒ‡å—**: `docs/START_WITH_EXISTING_SETUP.md`
- **Klipperå®é…ç½®**: `docs/KLIPPER_MACROS.cfg`
- **ç¡¬ä»¶æµ‹è¯•**: `experiments/test_existing_setup.py`

## ðŸŽ¯ ä¸‹ä¸€æ­¥

1. âœ… å®Œæˆæ•°æ®æ”¶é›†ï¼ˆå¤šä¸ªæ‰“å°ä»¶ï¼Œè‡³å°‘100å±‚ï¼‰
2. âœ… è®­ç»ƒPINNæ¨¡åž‹
3. âœ… åº”ç”¨G-codeä¿®æ­£
4. âœ… æ‰“å°éªŒè¯
5. âœ… ç²¾åº¦æµ‹é‡å’Œå¯¹æ¯”åˆ†æž

## ðŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ç”¨äºŽå­¦æœ¯ç ”ç©¶å’Œæ•™è‚²ç›®çš„ã€‚

## ðŸ¤ è´¡çŒ®

æ¬¢è¿Žæäº¤Issueå’ŒPull Requestï¼

---

**æœ€åŽæ›´æ–°**: 2025-02-05
**ç‰ˆæœ¬**: 1.0.0
