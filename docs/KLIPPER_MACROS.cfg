# Klipper宏配置 - 添加到printer.cfg
#
# 功能：每层完成时自动触发数据收集拍照
#
# 1. 将以下内容复制到您的printer.cfg文件末尾
# 2. 在Mainsail中重启Klipper
# 3. 开始打印，每层会自动调用此宏

# ==================================================
# 数据收集宏 - 每层完成时自动触发
# ==================================================

[gcode_macro LAYER_COMPLETE]
description: "触发数据收集拍照（每层完成时自动调用）"
gcode:
    # 打印日志
    {action_respond_info("Layer {printer.gcode_move.position_z} complete, capturing photo...")}

    # 发送HTTP请求到数据收集服务
    # 注意：IP地址和端口根据您的配置调整
    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.129:5000/capture",
            body={"layer": printer.gcode_move.position_z|int,
                   "filename": printer.print_stats.filename}
        )}
    {% endif %}

    # 如果HTTP请求失败，继续打印（不中断）
    {action_respond_info("Photo captured")}

# ==================================================
# 手动触发拍照（可选，用于测试）
# ==================================================

[gcode_macro PHOTO_CAPTURE]
description: "手动触发拍照（用于测试）"
gcode:
    {action_respond_info("Manually capturing photo...")}

    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.129:5000/capture",
            body={"layer": printer.gcode_move.position_z|int,
                   "filename": printer.print_stats.filename}
        )}
    {% endif %}

    {action_respond_info("Photo captured")}

# ==================================================
# 保存数据集（打印结束后调用）
# ==================================================

[gcode_macro SAVE_DATASET]
description: "保存收集的数据集"
gcode:
    {action_respond_info("Saving dataset...")}

    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.129:5000/save"
        )}
    {% endif %}

    {action_respond_info("Dataset saved")}

# ==================================================
# G-code后处理 - 自动插入LAYER_COMPLETE
# ==================================================

# 方案1：使用 slicer 后处理（推荐）
# 在您的slicer（Cura/PrusaSlicer）中：
# 1. 打开后处理设置
# 2. 添加以下代码到"每层结束后"：
#    LAYER_COMPLETE
#
# 或者修改 slicer 配置文件，在每层G-code末尾添加 LAYER_COMPLETE

# 方案2：使用Klipper的虚拟_sdcard（如果使用SD卡打印）
# [virtual_sdcard]
# path: ~/gcode_files
# on_error_gcode:
#   ; 检测层变化并触发
#   {% set current_z = printer.gcode_move.position_z %}
#   {% set prev_z = printer.save_variables.variables.prev_z|default(0) %}
#   {% if current_z != prev_z %}
#     LAYER_COMPLETE
#     SAVE_VARIABLE VARIABLE=prev_z VALUE={current_z}
#   {% endif %}

# ==================================================
# 测试宏
# ==================================================

# 测试摄像头连接
[gcode_macro TEST_CAMERA]
description: "测试IP摄像头连接"
gcode:
    {action_respond_info("Testing camera connection...")}

    # 这里可以添加HTTP测试请求
    # 或者提示用户手动测试

    {action_respond_info("Camera test: http://10.168.1.129:8080/shot.jpg")}

# 显示当前状态
[gcode_MACRO SHOW_STATUS]
description: "显示数据收集状态"
gcode:
    {action_respond_info("Data collection status:")}
    {action_respond_info("  Service: http://10.168.1.129:5000")}
    {action_respond_info("  Check status at: http://10.168.1.129:5000/status")}
