# ==================================================
# 简化版Klipper宏配置 - 适用于测试
# ==================================================
#
# 快速使用：
# 1. 复制以下内容到您的printer.cfg文件末尾
# 2. 在Mainsail中重启Klipper
# 3. 在控制台输入: TEST_PHOTO
# 4. 检查日志: type data\collection.log (Windows)
#
# 注意：请确保数据收集服务正在Windows PC上运行：
#   cd F:\TJ\3d_print\3d_printer_pinn4ieee
#   python experiments/auto_data_collector_existing.py \
#       --klipper-host 10.168.1.123 \
#       --camera-host 10.168.1.129 \
#       --output data/collected_photos
#
# 网络配置：
#   - Klipper机器: 10.168.1.123
#   - Windows PC: 10.168.1.118 (Flask服务端口5000)
#   - IP摄像头: 10.168.1.129 (端口8080)

# ==================================================
# 测试拍照宏（不依赖打印文件）
# ==================================================

[gcode_macro TEST_PHOTO]
description: "测试拍照功能（无需打印）"
gcode:
    # 获取当前Z位置
    {% set z_pos = printer.toolhead.position.z %}

    # 显示信息
    {action_respond_info("Testing photo capture at Z=%.3f..." % z_pos)}

    # 发送HTTP请求
    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.118:5000/capture",
            body={"layer": (z_pos * 1000)|int,
                   "filename": "manual_test"}
        )}
    {% endif %}

    # 完成
    {action_respond_info("Photo captured! Check data/collection.log")}

# ==================================================
# 完整LAYER_COMPLETE宏（用于打印时）
# ==================================================

[gcode_macro LAYER_COMPLETE]
description: "每层完成时自动拍照"
gcode:
    # 获取当前Z位置
    {% set z_pos = printer.toolhead.position.z %}

    # 显示信息
    {action_respond_info("Layer %.3f complete, capturing..." % z_pos)}

    # 发送HTTP请求到数据收集服务（Windows PC）
    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.118:5000/capture",
            body={"layer": (z_pos * 1000)|int,
                   "filename": printer.print_stats.filename}
        )}
    {% endif %}

    {action_respond_info("Capture complete")}

# ==================================================
# 查看收集状态
# ==================================================

[gcode_macro CHECK_COLLECTION]
description: "检查数据收集状态"
gcode:
    {action_respond_info("Data collection service status:")}
    {action_respond_info("  URL: http://10.168.1.118:5000")}
    {action_respond_info("  Check on Windows PC: curl http://localhost:5000/status")}

# ==================================================
# 保存数据集
# ==================================================

[gcode_macro SAVE_DATASET]
description: "保存收集的数据集"
gcode:
    {action_respond_info("Saving dataset...")}

    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.118:5000/save"
        )}
    {% endif %}

    {action_respond_info("Dataset save command sent")}
