# ==================================================
# Klipper数据收集配置 - 参数传递修复版
# ==================================================
#
# 网络配置：
#   Klipper机器: 10.168.1.123
#   Windows PC: 10.168.1.118 (Flask服务端口5000)
#   IP摄像头: 10.168.1.129 (端口8080)

# ==================================================
# Shell命令定义 - 使用位置参数
# ==================================================

[gcode_shell_command TRIGGER_PHOTO]
command: curl -s -X POST http://10.168.1.118:5000/capture -H "Content-Type: application/json" -d '{"layer": $1, "filename": "$2"}'
timeout: 10.0
verbose: false

[gcode_shell_command SAVE_DATASET]
command: curl -s -X POST http://10.168.1.118:5000/save
timeout: 5.0
verbose: false

[gcode_shell_command CHECK_SERVICE]
command: curl -s http://10.168.1.118:5000/status
timeout: 5.0
verbose: true

# ==================================================
# 测试拍照宏
# ==================================================

[gcode_macro TEST_PHOTO]
description: Test photo capture
gcode:
    {% set z_pos = printer.toolhead.position.z %}
    {% set layer_num = (z_pos * 1000)|int %}
    {action_respond_info("Testing photo: Z=%.3f mm, layer=%d" % (z_pos, layer_num))}
    RUN_SHELL_COMMAND CMD=TRIGGER_PHOTO PARAMS={layer_num} PARAMS=manual_test
    {action_respond_info("Photo command sent")}

# ==================================================
# 自动层拍照宏
# ==================================================

[gcode_macro LAYER_COMPLETE]
description: Auto capture on layer complete
gcode:
    {% set z_pos = printer.toolhead.position.z %}
    {% set layer_num = (z_pos * 1000)|int %}
    {% set filename = printer.print_stats.filename|default("unknown") %}
    {action_respond_info("Layer %.3f complete (%d um), capturing..." % (z_pos, layer_num))}
    RUN_SHELL_COMMAND CMD=TRIGGER_PHOTO PARAMS={layer_num} PARAMS={filename}
    {action_respond_info("Capture complete")}

# ==================================================
# 保存数据集宏
# ==================================================

[gcode_macro SAVE_DATASET]
description: Save collected dataset
gcode:
    {action_respond_info("Saving dataset...")}
    RUN_SHELL_COMMAND CMD=SAVE_DATASET
    {action_respond_info("Dataset save command sent")}

# ==================================================
# 检查服务状态宏
# ==================================================

[gcode_macro CHECK_SERVICE]
description: Check service status
gcode:
    {action_respond_info("Checking service status...")}
    RUN_SHELL_COMMAND CMD=CHECK_SERVICE
    {action_respond_info("Service running on http://10.168.1.118:5000")}
