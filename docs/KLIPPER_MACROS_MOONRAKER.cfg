# ==================================================
# Klipper宏配置 - 使用Moonraker http_client
# ==================================================
#
# 前提条件：
# - Moonraker v0.10.0+ ✅ (已安装)
# - http_client组件 ✅ (已启用)
# - Klipper v0.11.0+ (需要确认)
#
# 网络配置：
#   - Klipper机器: 10.168.1.123
#   - Windows PC: 10.168.1.118 (Flask服务)
#   - IP摄像头: 10.168.1.129

# ==================================================
# 测试拍照宏
# ==================================================

[gcode_macro TEST_PHOTO]
description: "测试拍照功能"
gcode:
    # 获取当前Z位置
    {% set z_pos = printer.toolhead.position.z %}

    # 显示信息
    {action_respond_info("========================================")}
    {action_respond_info("测试拍照功能")}
    {action_respond_info("========================================")}
    {action_respond_info("Z位置: %.3f mm" % z_pos)}
    {action_respond_info("目标: http://10.168.1.118:5000/capture")}
    {action_respond_info("========================================")}

    # 使用Moonraker的http_client发送请求
    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.118:5000/capture",
            body={"layer": (z_pos * 1000)|int,
                   "filename": "manual_test"}
        )}
    {% endif %}

    {action_respond_info("拍照命令已发送")}

# ==================================================
# 自动层拍照宏（用于打印时）
# ==================================================

[gcode_macro LAYER_COMPLETE]
description: "每层完成时自动拍照"
gcode:
    {% set z_pos = printer.toolhead.position.z %}

    {action_respond_info("Layer %.3f complete, capturing..." % z_pos)}

    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.118:5000/capture",
            body={"layer": (z_pos * 1000)|int,
                   "filename": printer.print_stats.filename}
        )}
    {% endif %}

    {action_respond_info("Capture complete")}

# ==================================================
# 保存数据集宏
# ==================================================

[gcode_macro SAVE_DATASET]
description: "保存收集的数据集"
gcode:
    {action_respond_info("保存数据集...")}

    {% set http_ok = True %}
    {% if http_ok %}
        {action_call_http(
            method="POST",
            url="http://10.168.1.118:5000/save"
        )}
    {% endif %}

    {action_respond_info("数据集保存命令已发送")}

# ==================================================
# 检查服务状态宏
# ==================================================

[gcode_macro CHECK_SERVICE]
description: "检查数据收集服务状态"
gcode:
    {action_respond_info("========================================")}
    {action_respond_info("数据收集服务状态")}
    {action_respond_info("========================================")}
    {action_respond_info("服务地址: http://10.168.1.118:5000")}
    {action_respond_info("在Windows PC上检查状态:")}
    {action_respond_info("  curl http://localhost:5000/status")}
    {action_respond_info("========================================")}

# ==================================================
# 显示当前配置信息
# ==================================================

[gcode_macro SHOW_NETWORK_CONFIG]
description: "显示网络配置"
gcode:
    {action_respond_info("========================================")}
    {action_respond_info("网络配置")}
    {action_respond_info("========================================")}
    {action_respond_info("Klipper机器: 10.168.1.123:19255")}
    {action_respond_info("Windows PC: 10.168.1.118:5000")}
    {action_respond_info("IP摄像头: 10.168.1.129:8080")}
    {action_respond_info("========================================")}
    {action_respond_info("使用方法:")}
    {action_respond_info("1. TEST_PHOTO - 手动测试拍照")}
    {action_respond_info("2. LAYER_COMPLETE - 层完成自动拍照")}
    {action_respond_info("3. SAVE_DATASET - 保存数据集")}
    {action_respond_info("4. CHECK_SERVICE - 检查服务状态")}
    {action_respond_info("========================================")}
