# ==================================================
# Klipper配置 - 使用gcode_shell_command扩展
# ==================================================
#
# 前提条件：
# 1. 安装gcode_shell_command扩展（通过KIAUH）
# 2. Klipper 0.13.0+
#
# 网络配置：
#   - Klipper机器: 10.168.1.123
#   - Windows PC: 10.168.1.118 (Flask服务端口5000)
#   - IP摄像头: 10.168.1.129 (端口8080)

# ==================================================
# 定义shell命令
# ==================================================

[gcode_shell_command TRIGGER_PHOTO]
command: curl -s -X POST http://10.168.1.118:5000/capture -H "Content-Type: application/json" -d '{"layer": {layer}, "filename": "{filename}"}'
timeout: 10.0
verbose: false

[gcode_shell_command SAVE_DATASET]
command: curl -s -X POST http://10.168.1.118:5000/save
timeout: 5.0
verbose: false

[gcode_shell_command CHECK_SERVICE]
command: curl -s http://10.168.1.118:5000/status
timeout: 5.0
verbose: true

# ==================================================
# 测试拍照宏
# ==================================================

[gcode_macro TEST_PHOTO]
description: "测试拍照功能"
gcode:
    # 获取当前Z位置
    {% set z_pos = printer.toolhead.position.z %}
    {% set layer_num = (z_pos * 1000)|int %}

    # 显示信息
    {action_respond_info("========================================")}
    {action_respond_info("测试拍照功能")}
    {action_respond_info("========================================")}
    {action_respond_info("Z位置: %.3f mm" % z_pos)}
    {action_respond_info("层号: %d um" % layer_num)}
    {action_respond_info("========================================")}

    # 调用shell命令
    RUN_SHELL_COMMAND CMD=TRIGGER_PHOTO PARAMS={layer_num} PARAMS=manual_test

    {action_respond_info("拍照命令已发送")}

# ==================================================
# 自动层拍照宏
# ==================================================

[gcode_macro LAYER_COMPLETE]
description: "每层完成时自动拍照"
gcode:
    {% set z_pos = printer.toolhead.position.z %}
    {% set layer_num = (z_pos * 1000)|int %}
    {% set filename = printer.print_stats.filename|default("unknown") %}

    {action_respond_info("Layer %.3f complete (%d um), capturing..." % (z_pos, layer_num))}

    # 调用shell命令，传递两个参数
    RUN_SHELL_COMMAND CMD=TRIGGER_PHOTO PARAMS={layer_num} PARAMS={filename}

    {action_respond_info("Capture complete")}

# ==================================================
# 保存数据集宏
# ==================================================

[gcode_macro SAVE_DATASET]
description: "保存收集的数据集"
gcode:
    {action_respond_info("保存数据集...")}

    RUN_SHELL_COMMAND CMD=SAVE_DATASET

    {action_respond_info("数据集保存命令已发送")}

# ==================================================
# 检查服务状态宏
# ==================================================

[gcode_macro CHECK_SERVICE]
description: "检查数据收集服务状态"
gcode:
    {action_respond_info("检查数据收集服务状态...")}
    RUN_SHELL_COMMAND CMD=CHECK_SERVICE
    {action_respond_info("========================================")}
    {action_respond_info("服务地址: http://10.168.1.118:5000")
    {action_respond_info("在Windows PC查看: curl http://localhost:5000/status")
    {action_respond_info("========================================")}

# ==================================================
# 显示配置信息
# ==================================================

[gcode_macro SHOW_CONFIG]
description: "显示网络和配置信息"
gcode:
    {action_respond_info("========================================")}
    {action_respond_info("数据收集系统配置")}
    {action_respond_info("========================================")}
    {action_respond_info("Klipper: 10.168.1.123:19255")}
    {action_respond_info("Windows PC: 10.168.1.118:5000")}
    {action_respond_info("IP摄像头: 10.168.1.129:8080")}
    {action_respond_info("========================================")}
    {action_respond_info("可用命令:")}
    {action_respond_info("  TEST_PHOTO      - 手动测试拍照")}
    {action_respond_info("  LAYER_COMPLETE  - 层完成自动拍照")}
    {action_respond_info("  SAVE_DATASET    - 保存数据集")}
    {action_respond_info("  CHECK_SERVICE   - 检查服务状态")}
    {action_respond_info("  SHOW_CONFIG     - 显示此信息")}
    {action_respond_info("========================================")}
